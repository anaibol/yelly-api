generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model City {
  id            String   @id @default(dbgenerated("generate_id()"))
  countryId     String
  name          String
  googlePlaceId String?  @unique
  lat           Float?
  lng           Float?
  country       Country  @relation(fields: [countryId], references: [id])
  schools       School[]

  @@index([countryId])
}

model Country {
  id   String @id @default(dbgenerated("generate_id()"))
  code String @unique
  city City[]
  tag  Tag[]
  user User[]
}

model Notification {
  id                String           @id @default(dbgenerated("generate_id()"))
  isSeen            Boolean          @default(false)
  createdAt         DateTime         @default(now())
  userId            String
  type              NotificationType
  postReactionId    BigInt?          @unique
  postReaction      PostReaction?    @relation(fields: [postReactionId], references: [id], onDelete: Cascade)
  tagReactionId     BigInt?          @unique
  tagReaction       TagReaction?     @relation(fields: [tagReactionId], references: [id], onDelete: Cascade)
  tagId             BigInt?
  tag               Tag?             @relation(fields: [tagId], references: [id], onDelete: Cascade)
  postId            BigInt?
  post              Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  followerUser      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  followerUserId    String?
  newPostCount      Int?
  postUserMention   PostUserMention? @relation(fields: [postUserMentionId], references: [id], onDelete: Cascade)
  postUserMentionId BigInt?          @unique

  @@index([createdAt], map: "Notification_createdAt")
  @@index([userId])
}

model Activity {
  id                BigInt           @id @default(dbgenerated("generate_id()"))
  createdAt         DateTime         @default(now())
  postId            BigInt?
  post              Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId             BigInt?
  tag               Tag?             @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagReactionId     BigInt?          @unique
  tagReaction       TagReaction?     @relation(fields: [tagReactionId], references: [id], onDelete: Cascade)
  user              User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              ActivityType
  userId            String
  postUserMention   PostUserMention? @relation(fields: [postUserMentionId], references: [id], onDelete: Cascade)
  postUserMentionId BigInt?          @unique

  @@index([createdAt], map: "Activity_createdAt")
}

model School {
  id            String  @id @default(dbgenerated("generate_id()"))
  name          String
  googlePlaceId String? @unique
  lat           Float?
  lng           Float?
  cityId        String
  city          City    @relation(fields: [cityId], references: [id])
  users         User[]
}

model Training {
  id   String @id @default(dbgenerated("generate_id()"))
  name String @unique
  user User[]
}

model User {
  id                           String                            @id @default(dbgenerated("generate_id()"))
  firstName                    String?
  lastName                     String?
  email                        String?                           @unique
  role                         UserRole                          @default(USER)
  password                     String?
  birthdate                    DateTime?                         @db.Date
  pictureId                    String?
  facePictureId                String?
  isAgeApproved                Boolean?
  ageEstimation                Int?
  agePredictionResult          String?
  snapchat                     String?
  instagram                    String?
  resetToken                   String?
  isVerified                   Boolean                           @default(true)
  createdAt                    DateTime                          @default(now())
  updatedAt                    DateTime                          @default(now()) @updatedAt
  isActive                     Boolean                           @default(true)
  isBanned                     Boolean                           @default(false)
  isFilled                     Boolean                           @default(false)
  androidPushnotificationToken String?
  iosPushnotificationToken     String?
  about                        String?
  locale                       String?
  trainingId                   String?
  schoolId                     String?
  countryId                    String?
  country                      Country?                          @relation(fields: [countryId], references: [id])
  phoneNumber                  String?                           @unique
  school                       School?                           @relation(fields: [schoolId], references: [id])
  training                     Training?                         @relation(fields: [trainingId], references: [id])
  expoPushNotificationTokens   ExpoPushNotificationAccessToken[]
  posts                        Post[]
  postReactions                PostReaction[]
  postPollVotes                PostPollVote[]
  tagReactions                 TagReaction[]
  followees                    Follower[]                        @relation("usersAsFollowees")
  followers                    Follower[]                        @relation("usersAsFollowers")
  activities                   Activity[]
  viewsCount                   Int                               @default(0)
  tags                         Tag[]
  notifications                Notification[]
  postMentions                 PostUserMention[]

  @@index([birthdate], map: "User_birthdate")
}

model Follower {
  id         String   @unique @default(dbgenerated("generate_id()"))
  userId     String
  followeeId String
  createdAt  DateTime @default(now())
  user       User     @relation("usersAsFollowees", fields: [userId], references: [id], onDelete: Cascade)
  followee   User     @relation("usersAsFollowers", fields: [followeeId], references: [id], onDelete: Cascade)

  @@id([userId, followeeId])
}

model Tag {
  id            BigInt         @id @default(dbgenerated("generate_id()"))
  text          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt
  posts         Post[]
  countryId     String?
  country       Country?       @relation(fields: [countryId], references: [id])
  isHidden      Boolean        @default(false)
  author        User?          @relation(fields: [authorId], references: [id])
  authorId      String?
  reactions     TagReaction[]
  viewsCount    Int            @default(0)
  activities    Activity[]
  notifications Notification[]

  @@index([createdAt])
  @@index([authorId])
  @@index([isHidden])
}

model Post {
  id            BigInt            @id @default(dbgenerated("generate_id()"))
  text          String            @db.Text
  createdAt     DateTime          @unique @default(now())
  authorId      String
  viewsCount    Int               @default(0)
  author        User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tags          Tag[]
  reactions     PostReaction[]
  pollOptions   PostPollOption[]
  pollVotes     PostPollVote[]
  children      Post[]            @relation("parentChildren")
  parent        Post?             @relation("parentChildren", fields: [parentId], references: [id])
  parentId      BigInt?
  activities    Activity[]
  notifications Notification[]
  charsCount    Int?
  wordsCount    Int?
  userMentions  PostUserMention[]

  @@index([authorId])
}

model PostUserMention {
  id           BigInt        @id @default(dbgenerated("generate_id()"))
  createdAt    DateTime      @default(now())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId       BigInt
  post         Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  activity     Activity?
  activityId   String?
  notification Notification?
  notificationId String?

  @@index([postId])
}

model PostPollOption {
  id       BigInt         @id @default(dbgenerated("generate_id()"))
  text     String
  post     Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId   BigInt
  position Int
  votes    PostPollVote[]

  @@index([postId])
}

model PostPollVote {
  id        BigInt         @id @default(dbgenerated("generate_id()"))
  option    PostPollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  optionId  BigInt
  post      Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    BigInt
  authorId  String
  author    User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now())

  @@unique([authorId, postId])
  @@index([optionId])
  @@index([postId])
}

model PostReaction {
  id           BigInt        @id @default(dbgenerated("generate_id()"))
  createdAt    DateTime      @default(now())
  text         String
  postId       BigInt
  authorId     String
  author       User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post         Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  notification Notification?
  notificationId String?

  @@unique([authorId, postId])
}

model TagReaction {
  id           BigInt        @id @default(dbgenerated("generate_id()"))
  createdAt    DateTime      @default(now())
  text         String
  tagId        BigInt
  authorId     String
  author       User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tag          Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)
  activity     Activity?
  activityId   String?
  notification Notification?
  notificationId String?

  @@unique([authorId, tagId])
}

model ExpoPushNotificationAccessToken {
  id     String @id @default(dbgenerated("generate_id()"))
  userId String
  token  String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

enum NotificationType {
  REPLIED_TO_YOUR_POST
  REPLIED_TO_SAME_POST_AS_YOU
  REACTED_TO_YOUR_POST
  REACTED_TO_YOUR_TAG
  IS_NOW_FOLLOWING_YOU
  YOUR_TAG_IS_TRENDING
  THERE_ARE_NEW_POSTS_ON_YOUR_TAG
  USER_MENTIONED_YOU
}

enum ActivityType {
  CREATED_TAG_REACTION
  CREATED_TAG
  CREATED_POST
  CREATED_POST_USER_MENTION
}
